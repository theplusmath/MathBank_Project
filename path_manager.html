<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²½ë¡œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <style>
    body {
      font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
      padding: 20px;
    }
    select {
      width: 300px;
      margin-bottom: 10px;
    }
    input[type="text"] {
      width: 300px;
      padding: 5px;
      margin-bottom: 10px;
    }
    button {
      margin-right: 5px;
      padding: 5px 10px;
    }
    .section {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“š 6ë‹¨ê³„ ê²½ë¡œ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>

  <div id="dropdowns">
    <select id="depth-0"><option value="">-- êµìœ¡ê³¼ì • ì„ íƒ --</option></select><br>
    <select id="depth-1"><option value="">-- ê³ ë“±/ì¤‘ë“± ì„ íƒ --</option></select><br>
    <select id="depth-2"><option value="">-- êµê³¼ì„œ ì„ íƒ --</option></select><br>
    <select id="depth-3"><option value="">-- ëŒ€ë‹¨ì› ì„ íƒ --</option></select><br>
    <select id="depth-4"><option value="">-- ì¤‘ë‹¨ì› ì„ íƒ --</option></select><br>
    <select id="depth-5"><option value="">-- ì†Œë‹¨ì› ì„ íƒ --</option></select><br>
  </div>

  <div class="section">
    <input type="text" id="newPathName" placeholder="â• ìƒˆ ê²½ë¡œ ì´ë¦„">
    <button onclick="addPath()">ë“±ë¡</button>
  </div>

  <div class="section">
    <input type="text" id="editPathName" placeholder="âœï¸ ìˆ˜ì •í•  ì´ë¦„">
    <button onclick="renamePath()">ì´ë¦„ ìˆ˜ì •</button>
  </div>

  <div class="section">
    <button onclick="movePath(-1)">â¬†ï¸ ìœ„ë¡œ</button>
    <button onclick="movePath(1)">â¬‡ï¸ ì•„ë˜ë¡œ</button>
    <button onclick="deletePath()">ğŸ—‘ï¸ ì‚­ì œ</button>
  </div>

  <script>
    const depthCount = 6;
    const dropdowns = Array.from({ length: depthCount }, (_, i) => document.getElementById(`depth-${i}`));

    function clearDropdowns(start) {
      for (let i = start; i < depthCount; i++) {
        dropdowns[i].innerHTML = `<option value="">-- ì„ íƒ --</option>`;
      }
    }

    function loadChildPaths(parentId, depth) {
      fetch('select_path.php')
        .then(res => res.json())
        .then(json => {
          const allPaths = json.data;
          const children = allPaths.filter(p => String(p.parent_id) === String(parentId));
          clearDropdowns(depth);
          children.forEach(child => {
            const option = document.createElement('option');
            option.value = child.id;
            option.textContent = child.name;
            dropdowns[depth].appendChild(option);
          });
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadChildPaths(null, 0);
    });

    dropdowns.forEach((dropdown, i) => {
      dropdown.addEventListener('change', () => {
        const selectedId = dropdown.value;
        if (i < depthCount - 1) {
          loadChildPaths(selectedId, i + 1);
        }
      });
    });

    function getSelectedPath() {
      for (let i = depthCount - 1; i >= 0; i--) {
        if (dropdowns[i].value) return { id: dropdowns[i].value, depth: i };
      }
      return { id: null, depth: 0 };
    }

    function addPath() {
      const name = document.getElementById('newPathName').value.trim();
      if (!name) return alert("ìƒˆ ê²½ë¡œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

      const { id: parentId, depth } = getSelectedPath();

      const formData = new URLSearchParams();
      formData.append('name', name);
      formData.append('parent_id', parentId ?? '');
      formData.append('depth', depth + 1);

      fetch('insert_path.php', {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            alert("ë“±ë¡ ì„±ê³µ!");
            loadChildPaths(parentId, depth + 1);
            document.getElementById('newPathName').value = '';
          } else {
            alert("ë“±ë¡ ì‹¤íŒ¨: " + json.message);
          }
        });
    }

    function renamePath() {
      const name = document.getElementById('editPathName').value.trim();
      if (!name) return alert("ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const { id } = getSelectedPath();
      if (!id) return alert("ìˆ˜ì •í•  ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.");

      const formData = new URLSearchParams();
      formData.append('id', id);
      formData.append('name', name);

      fetch('update_path.php', {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            alert("ì´ë¦„ ìˆ˜ì • ì™„ë£Œ!");
            location.reload();
          } else {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + json.message);
          }
        });
    }

    function movePath(direction) {
      const { id } = getSelectedPath();
      if (!id) return alert("ì´ë™í•  ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.");

      const formData = new URLSearchParams();
      formData.append('id', id);
      formData.append('direction', direction);

      fetch('move_path.php', {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            alert("ì´ë™ ì™„ë£Œ!");
            location.reload();
          } else {
            alert("ì´ë™ ì‹¤íŒ¨: " + json.message);
          }
        });
    }

    function deletePath() {
      const { id } = getSelectedPath();
      if (!id) return alert("ì‚­ì œí•  ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•˜ìœ„ í•­ëª©ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.")) return;

      fetch(`delete_path.php?id=${id}`)
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            alert("ì‚­ì œ ì™„ë£Œ!");
            location.reload();
          } else {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + json.message);
          }
        });
    }
  </script>
</body>
</html>
