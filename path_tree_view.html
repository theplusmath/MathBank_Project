<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²½ë¡œ íŠ¸ë¦¬ ë³´ê¸°</title>
  <style>
    body {
      font-family: 'Malgun Gothic', sans-serif;
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
    }
    ul { list-style-type: none; padding-left: 20px; }
    .folder { margin: 5px 0; cursor: pointer; }
    .folder-label {
      font-weight: bold;
      padding: 3px 6px;
      display: inline-block;
      cursor: pointer;
    }
    .folder-label.selected {
      background-color: #d0ebff;
      border-radius: 4px;
    }
    .children {
      margin-left: 15px;
      display: none;
    }
    .folder.open > .children {
      display: block;
    }
    #contextMenu {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      display: none;
      z-index: 1000;
    }
    #contextMenu div {
      padding: 8px 12px;
      cursor: pointer;
    }
    #contextMenu div:hover {
      background-color: #f0f0f0;
    }
    #selectedIdText {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #004080;
    }
    .drag-over {
      outline: 2px dashed #3399ff;
      background-color: #eaf4ff;
    }


    .highlight {
      background: #ffe063 !important;
      font-weight: bold;
    }

  </style>
</head>
<body>
  <h2>ğŸ“ ê²½ë¡œ íŠ¸ë¦¬ ë³´ê¸°</h2>
  <input type="text" id="treeSearchInput" placeholder="ê²½ë¡œëª… ê²€ìƒ‰..." style="margin-bottom:10px; width:90%;">
  <div id="pathTree"></div>
  <div id="selectedIdText">ì„ íƒëœ ê²½ë¡œ ID: ì—†ìŒ</div>
  <div id="contextMenu">
    <div id="addChildOption">â• í•˜ìœ„ ê²½ë¡œ ì¶”ê°€</div>
    <div id="renameOption">âœï¸ ì´ë¦„ ìˆ˜ì •</div>
    <div id="deleteOption">ğŸ—‘ ì‚­ì œ</div>
  </div>

  <script>
    let currentRightClickNode = null;
    let lastInsertedNode = null;
    let draggedItem = null;
    let selectedNodeId = localStorage.getItem('selectedPathId') || null;	
    let lastMoved = null;
    let lastDeletedNode = null;

    function highlightSelectedNode(id) {
      // idê°€ ì—†ê±°ë‚˜(ì´ˆê¸°í™”) ì„ íƒëœ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì „ì²´ í•´ì œ
      if (!id) {
        document.querySelectorAll(".folder-label").forEach(s => s.classList.remove("selected"));
        document.getElementById("selectedIdText").textContent = `ì„ íƒëœ ê²½ë¡œ ID: ì—†ìŒ`;
        return;
      }
      const selectedEl = document.querySelector(`.folder-label[data-id='${id}']`);

      if (selectedEl) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ ë° í˜„ì¬ ì„ íƒ
        document.querySelectorAll(".folder-label").forEach(s => s.classList.remove("selected"));
        selectedEl.classList.add("selected");
        selectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById("selectedIdText").textContent = `ì„ íƒëœ ê²½ë¡œ ID: ${id}`;

        // 1ï¸âƒ£ íŠ¸ë¦¬ ìë™ í¼ì¹¨: ë¶€ëª¨ <li> ëª¨ë‘ open!
        let li = selectedEl.parentElement;
        while (li && li.tagName === 'LI') {
          li.classList.add('open');
          // ìƒìœ„ <ul>
          li = li.parentElement;
          // ìƒìœ„ <li> (íŠ¸ë¦¬ êµ¬ì¡°ì— ë”°ë¼ ul â†’ li â†’ ul â†’ li ...)
          if (!li) break;
          li = li.parentElement;
        }
      } else {
        document.querySelectorAll(".folder-label").forEach(s => s.classList.remove("selected"));
        document.getElementById("selectedIdText").textContent = `ì„ íƒëœ ê²½ë¡œ ID: ì—†ìŒ`;
      }
    }






    async function fetchPaths() {
      const res = await fetch('get_path_tree_flat_paths.php');
      const flatPaths = await res.json();

      const pathMap = new Map();
      flatPaths.forEach(p => pathMap.set(p.id, { ...p, children: [] }));

      flatPaths.forEach(p => {
        if (p.parent_id !== null && p.parent_id !== 0) {
          const parent = pathMap.get(p.parent_id);
          if (parent) parent.children.push(pathMap.get(p.id));
        }
      });

      const roots = flatPaths.filter(p => p.parent_id === 0 || p.parent_id === null || p.parent_id === "null");
      const container = document.getElementById("pathTree");
      container.innerHTML = '';

      const ulRoot = document.createElement("ul");
      roots.forEach(root => {
        ulRoot.appendChild(createTreeElement(pathMap.get(root.id)));
      });
      container.appendChild(ulRoot);

      // ë§ˆì§€ë§‰ìœ¼ë¡œ ì‘ì—…í•œ ë…¸ë“œì— í¬ì»¤ìŠ¤/ì„ íƒ í‘œì‹œ ìœ ì§€
      if (selectedNodeId) highlightSelectedNode(selectedNodeId);
    }

    function createTreeElement(node) {
  const li = document.createElement("li");
  li.classList.add("folder");

  // ì‚¼ê°í˜• ì•„ì´ì½˜
  const icon = document.createElement("span");
  icon.style.display = "inline-block";
  icon.style.width = "20px";
  icon.style.cursor = "pointer";
  icon.style.userSelect = "none";
  icon.textContent = node.children.length > 0 ? "â–¶" : "ã€€"; // ìì‹ ìˆìœ¼ë©´ â–¶, ì—†ìœ¼ë©´ ê³µë°±

  // ì•„ì´ì½˜ í´ë¦­ ì‹œ í•˜ìœ„ íŠ¸ë¦¬ ì—´ê³  ë‹«ê¸°
  icon.addEventListener("click", (e) => {
    e.stopPropagation();
    li.classList.toggle("open");
    // ì•„ì´ì½˜ ëª¨ì–‘ ì—…ë°ì´íŠ¸
    icon.textContent = (li.classList.contains("open") && node.children.length > 0) ? "â–¼" :
      (node.children.length > 0 ? "â–¶" : "ã€€");
  });

  // ê²½ë¡œëª…
  const span = document.createElement("span");
  span.textContent = node.name;
  span.className = "folder-label";
  span.dataset.id = node.id;

  // í´ë¦­ì‹œ ì„ íƒë§Œ
  span.addEventListener("click", (e) => {
  e.stopPropagation();
  selectedNodeId = node.id;
  highlightSelectedNode(node.id);
  localStorage.setItem('selectedPathId', node.id);
  });

  // ë”ë¸”í´ë¦­ì‹œ íŠ¸ë¦¬ ì—´ê³  ë‹«ê¸° (ì•„ì´ì½˜ê³¼ ë™ì¼)
  span.addEventListener("dblclick", (e) => {
    e.stopPropagation();
    li.classList.toggle("open");
    icon.textContent = (li.classList.contains("open") && node.children.length > 0) ? "â–¼" :
      (node.children.length > 0 ? "â–¶" : "ã€€");
  });

  span.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    currentRightClickNode = node;
    showContextMenu(e.pageX, e.pageY);
  });

  // ë“œë˜ê·¸ ë“± ê¸°ì¡´ ì½”ë“œ ë™ì¼...
  span.setAttribute("draggable", true);
  // ... ì´í•˜ ë™ì¼

  // ----- [ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€] -----
  span.addEventListener("dragstart", (e) => {
    draggedItem = node;
    span.classList.add("drag-over");
    e.dataTransfer.effectAllowed = "move";
  });
  span.addEventListener("dragover", (e) => {
    e.preventDefault();
    span.classList.add("drag-over");
  });
  span.addEventListener("dragleave", (e) => {
    span.classList.remove("drag-over");
  });
  span.addEventListener("drop", (e) => {
    e.preventDefault();
    span.classList.remove("drag-over");
    if (!draggedItem || draggedItem.id === node.id) return;
    fetch("reorder_path.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        dragged_id: draggedItem.id,
        new_parent_id: node.parent_id, // ê°™ì€ ë¶€ëª¨ë¼ë©´ ê·¸ëŒ€ë¡œ
        target_id: node.id // í˜•ì œ id
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        selectedNodeId = draggedItem.id;
        highlightSelectedNode(draggedItem.id);
        lastInsertedNode = { id: draggedItem.id };
        fetchPaths();
      } else {
        alert("ì´ë™ ì‹¤íŒ¨: " + (data.message || ""));
      }
      draggedItem = null;
    });
  });
  span.addEventListener("dragend", (e) => {
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    draggedItem = null;
  });
  // ----- [ë“œë˜ê·¸ ê¸°ëŠ¥ ë] -----






  // liì— ì•„ì´ì½˜ê³¼ ê²½ë¡œëª… spanì„ append
  li.appendChild(icon);
  li.appendChild(span);

  if (node.children.length > 0) {
    const ul = document.createElement("ul");
    ul.classList.add("children");
    node.children.forEach(child => {
      ul.appendChild(createTreeElement(child));
    });
    li.appendChild(ul);
  }

  return li;
}


    function showContextMenu(x, y) {
      const menu = document.getElementById("contextMenu");
      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
      menu.style.display = "block";
    }

    document.addEventListener("click", () => {
      document.getElementById("contextMenu").style.display = "none";
    });





    document.getElementById("deleteOption").addEventListener("click", () => {
      if (!currentRightClickNode) return;
      if (!confirm(`"${currentRightClickNode.name}" ê²½ë¡œë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;

      lastDeletedNode = { ...currentRightClickNode };

      fetch("delete_path.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `id=${encodeURIComponent(currentRightClickNode.id)}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          fetchPaths();
        } else {
          alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || ""));
        }
      });
    });


    document.getElementById("renameOption").addEventListener("click", () => {
      if (!currentRightClickNode) return;
      const newName = prompt("ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", currentRightClickNode.name);
      if (!newName || newName.trim() === "" || newName === currentRightClickNode.name) return;

      fetch("update_path.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: currentRightClickNode.id,
          name: newName,
          parent_id: currentRightClickNode.parent_id    // âœ… ì´ ë¶€ë¶„ ë°˜ë“œì‹œ í¬í•¨!
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          selectedNodeId = currentRightClickNode.id;  // â† ì´ ì¤„ ì¶”ê°€!
          highlightSelectedNode(currentRightClickNode.id);
          lastInsertedNode = { id: currentRightClickNode.id }; // â­ï¸ ì´ë¦„ ë°”ê¾¼ í›„ í•´ë‹¹ ë…¸ë“œë¡œ í¬ì»¤ìŠ¤
          fetchPaths();
        } else {
          alert("ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨: " + (data.message || ""));
        }
      });
    });





    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'z') {
        if (lastMoved) {
          fetch("reorder_path.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              dragged_id: lastMoved.dragged_id,
              target_id: null,
              new_parent_id: lastMoved.original_parent_id
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              fetchPaths();
              lastMoved = null;
            } else {
              alert("ì‹¤í–‰ì·¨ì†Œ ì‹¤íŒ¨: " + (data.message || ""));
            }
          });
        } else if (lastDeletedNode) {
          fetch("insert_path.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: lastDeletedNode.id,
              parent_id: lastDeletedNode.parent_id,
              name: lastDeletedNode.name,
              depth: lastDeletedNode.depth,
              sort_order: lastDeletedNode.sort_order
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              lastInsertedNode = { id: lastDeletedNode.id };
              fetchPaths();
              lastDeletedNode = null;
            } else {
              alert("ì‚­ì œ ë³µì› ì‹¤íŒ¨: " + (data.message || ""));
            }
          });
        }
      }
    });

    document.getElementById("addChildOption").addEventListener("click", () => {
      if (!currentRightClickNode) return;
      const childName = prompt("ì¶”ê°€í•  í•˜ìœ„ ê²½ë¡œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
      if (!childName) return;
    
      // í˜„ì¬ ë¶€ëª¨ì˜ í•˜ìœ„ ê²½ë¡œ ê°œìˆ˜ + 1ë¡œ sort_order ê³„ì‚°
      const newSortOrder =
        Array.isArray(currentRightClickNode.children)
          ? currentRightClickNode.children.length + 1
          : 1;

      fetch("insert_path.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          parent_id: currentRightClickNode.id,
          name: childName,
          depth: (parseInt(currentRightClickNode.depth, 10) || 0) + 1,
          sort_order: newSortOrder
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.inserted && data.inserted.id) {
            selectedNodeId = data.inserted.id; // â† ì´ ì¤„ ì¶”ê°€!
            highlightSelectedNode(data.inserted.id);
            lastInsertedNode = { id: data.inserted.id };
          }
          fetchPaths();
        } else {
          alert("ì¶”ê°€ ì‹¤íŒ¨: " + (data.message || ""));
        }
      });
    });



    document.addEventListener("DOMContentLoaded", fetchPaths);

    // â‘¡ ê²€ìƒ‰ ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° í•„í„°ë§ í•¨ìˆ˜ ì¶”ê°€
    document.getElementById('treeSearchInput').addEventListener('input', function() {
      const keyword = this.value.trim();
      filterTreeNodes(keyword);
    });

    function filterTreeNodes(keyword) {
      const nodes = document.querySelectorAll('.folder-label');
      keyword = keyword.toLowerCase();
      // ë¨¼ì € ì „ì²´ íŠ¸ë¦¬ ë‹«ê¸°
      document.querySelectorAll('li.folder.open').forEach(li => li.classList.remove('open'));
  
      let firstHighlighted = null;
      nodes.forEach(node => {
        const text = node.textContent.toLowerCase();
        const isHit = keyword && text.includes(keyword);
        node.classList.toggle('highlight', isHit);

        if (isHit && !firstHighlighted) firstHighlighted = node;

        // íŠ¸ë¦¬ ì „ì²´ëŠ” í•­ìƒ ë³´ì´ê³ , displayëŠ” ë³€ê²½í•˜ì§€ ì•ŠëŠ”ë‹¤!
      });

      // í•˜ì´ë¼ì´íŠ¸ëœ ë…¸ë“œì˜ ë¶€ëª¨ í´ë” ìë™ open
      if (firstHighlighted) {
        let li = firstHighlighted.parentElement;
        while (li && li.tagName === 'LI') {
          li.classList.add('open');
          // li.parentElement: ul â†’ li ë°˜ë³µ êµ¬ì¡°
          li = li.parentElement;
          if (!li) break;
          li = li.parentElement;
        }
        // í•˜ì´ë¼ì´íŠ¸ëœ ë…¸ë“œë¡œ ìŠ¤í¬ë¡¤ë„ ì¶”ê°€ (ì„ íƒ)
        firstHighlighted.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }






  </script>
</body>
</html>
