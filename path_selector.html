<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²½ë¡œ ì„ íƒê¸°</title>
  <style>
    select { margin-bottom: 10px; }
    input[type="text"] { margin-right: 5px; }
  </style>
</head>
<body>
  <h2>ğŸ“š ê²½ë¡œ ì„ íƒ (6ë‹¨)</h2>

  <div id="dropdowns">
    <select id="depth-0"><option>-- êµìœ¡ê³¼ì • ì„ íƒ --</option></select><br>
    <select id="depth-1"><option>-- ìˆ˜í•™ êµ¬ë¶„ ì„ íƒ --</option></select><br>
    <select id="depth-2"><option>-- êµê³¼ì„œ ì„ íƒ --</option></select><br>
    <select id="depth-3"><option>-- ëŒ€ë‹¨ì› ì„ íƒ --</option></select><br>
    <select id="depth-4"><option>-- ì¤‘ë‹¨ì› ì„ íƒ --</option></select><br>
    <select id="depth-5"><option>-- ì†Œë‹¨ì› ì„ íƒ --</option></select><br><br>
  </div>

  <div>
    <input type="text" id="newPathName" placeholder="ìƒˆ ê²½ë¡œ ì´ë¦„ ì…ë ¥">
    <button onclick="addPath()">â• í•˜ìœ„ ê²½ë¡œ ë“±ë¡</button>
    <button onclick="deletePath()">ğŸ—‘ï¸ í˜„ì¬ ê²½ë¡œ ì‚­ì œ</button>
  </div>

  <div id="message" style="margin-top:20px;color:green;"></div>

  <script>
    const depthCount = 6;
    const dropdowns = Array.from({ length: depthCount }, (_, i) => document.getElementById(`depth-${i}`));
    const messageDiv = document.getElementById('message');

    function clearDropdowns(start) {
      for (let i = start; i < depthCount; i++) {
        dropdowns[i].innerHTML = `<option value="">-- ì„ íƒ --</option>`;
      }
    }

    function loadChildPaths(parentId, depth) {
      fetch('select_path.php')
        .then(res => res.json())
        .then(json => {
          const allPaths = json.data;
          const children = allPaths.filter(p => String(p.parent_id) === String(parentId));
          clearDropdowns(depth);
          children.forEach(child => {
            const option = document.createElement('option');
            option.value = child.id;
            option.textContent = child.name;
            dropdowns[depth].appendChild(option);
          });
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadChildPaths(null, 0);
    });

    dropdowns.forEach((dropdown, i) => {
      dropdown.addEventListener('change', () => {
        const selectedId = dropdown.value;
        if (i < depthCount - 1) {
          loadChildPaths(selectedId, i + 1);
        }
      });
    });

    function addPath() {
      const name = document.getElementById('newPathName').value.trim();
      if (!name) {
        alert("ê²½ë¡œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      let parentId = null;
      let depth = 0;

      for (let i = 0; i < depthCount; i++) {
        const val = dropdowns[i].value;
        if (val) {
          parentId = val;
          depth = i + 1;
        }
      }

      const formData = new URLSearchParams();
      formData.append('name', name);
      formData.append('parent_id', parentId ?? '');
      formData.append('depth', depth);

      fetch('insert_path.php', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(json => {
        if (json.success) {
          alert("ë“±ë¡ ì„±ê³µ! ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°˜ì˜ë©ë‹ˆë‹¤.");
          loadChildPaths(parentId, depth);
          document.getElementById('newPathName').value = '';
        } else {
          alert("ë“±ë¡ ì‹¤íŒ¨: " + json.message);
        }
      });
    }

    function deletePath() {
      let targetId = null;
      for (let i = depthCount - 1; i >= 0; i--) {
        const val = dropdowns[i].value;
        if (val) {
          targetId = val;
          break;
        }
      }
      if (!targetId) {
        alert("ì‚­ì œí•  ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•˜ìœ„ í•­ëª©ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.")) return;

      fetch(`delete_path.php?id=${targetId}`)
        .then(res => res.json())
        .then(json => {
          if (json.success) {
            alert("ì‚­ì œ ì™„ë£Œ!");
            location.reload();
          } else {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + json.message);
          }
        });
    }
  </script>
</body>
</html>
